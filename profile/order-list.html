<?php

$type = isset($_GET['type']) ? $_GET['type'] : 'all';

include '../dbConnect.php';
$userIx = $_COOKIE['user_ix'];
$login_contact = str_replace("-", "", $_COOKIE['login_contact']);

?>

<!DOCTYPE html>
<html>
<head>
	<meta name="code" charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=0,maximum-scale=10,user-scalable=yes"/>
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="../STATIC/js/common.js"></script>
	<script type="text/javascript" src="../STATIC/js/swiper-bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
	<link rel="stylesheet" type="text/css" href="../STATIC/css/swiper-bundle.min.css"/>
	<link rel="stylesheet" type="text/css" href="../STATIC/css/style.css"/>
	<link rel="stylesheet" type="text/css" href="../STATIC/css/order-list.css"/>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
<style>
</head>
<style type="text/css">
	.info_menu{
		border: 1px solid #ebebeb;
		border-radius: 12px;
	}

</style>
<body>
	<?php include '../header.html'; ?>
	<div id="container">
		<section class="aside_section">
			<div class="inner">
				<aside class="side_menu">
					<div class="sticky">
						<article class="info_menu">
							<ul>
								<li class="active"><a href="./order-list.html">주문 내역</a></li>
								<li><a href="./points.html">포인트</a></li>
								<li><a href="./info.html">내 정보 관리</a></li>
							</ul>
						</article>
					</div>
				</aside>
				<article class="content">
					<h1 class="ct_title">주문/배송 목록</h1>
					<ul class="category-btn-list">
						<li>
							<a class="active-category-btn" data-v='all'>주문내역</a>
						</li>
						<li>
							<a data-v='pending'>준비중</a>
						</li>
						<li>
							<a data-v='processing'>배송중</a>
						</li>
						<li>
							<a data-v='completed'>배송완료</a>
						</li>
						<li>
							<a data-v='retrieval'>회수중</a>
						</li>
						<li>
							<a data-v='returned'>회수완료</a>
						</li>
						<li>
							<a data-v='cancelled'>취소</a>
						</li>
					</ul>
					
					<div class="spacing"></div>
					<?php 
					$orderSql = "SELECT * FROM orders WHERE user_ix='$userIx'";
					$orderResult = $conn->query($orderSql);

					if($orderResult->num_rows <= 0){
					 ?>
					
					<div class="list-empty">
						<div class="empty-state">
							<h1>주문 내역이 없습니다.</h1>
						</div>
					</div>
					<?php }else{ ?>
					<div class="list-order">
						<table class="list-table">
							<thead>
								<tr>
									<th scope="col">주문정보</th>		
									<th scope="col">금액</th>
									<th scope="col">상태</th>
									<th scope="col">활동</th>
								</tr>
							</thead>
							<tbody id="orderData">
								<tr data-ix="22">
									<td class="align_left">
										<div>
											<img src="../STATIC/img/book/9791186993095.jpg">
											<span class="ord_num">
												<span class="label">주문번호 :</span>
												<a >
													<span class="text">1643706618</span>
												</a>
												<p>검은꽃 외 1권</p>
											</span>

										</div>   
									</td>
									<td>10,350원</td>
									<td class="cmain fwb">배송준비중</td>
									<td class="btnBox">
										<button class="order-sub-btn order-cancel">주문취소</button>
									</td>
								</tr>
								<tr>
									<td class="align_left">
										<div>
											<img src="../STATIC/img/book/9791186993095.jpg">
											<span class="ord_num">
												<span class="label">주문번호 :</span>
												<a >
													<span class="text">1643706618</span>
												</a>
												<p>검은꽃 외 1권</p>
											</span>

										</div>
									</td>
									<td>10,500원</td>
									<td class="cmain fwb">배송중</td>
									<td class="btnBox">
										<button class="order-sub-btn order-return">반품신청</button>
									</td>
								</tr>
								<tr>
									<td class="align_left">
										<div>
											<img src="../STATIC/img/book/9791186993095.jpg">
											<span class="ord_num">
												<span class="label">주문번호 :</span>
												<a >
													<span class="text">1643706618</span>
												</a>
												<p>검은꽃 외 1권</p>
											</span>

										</div>
									</td>
									<td>10,500원</td>
									<td class="cmain fwb">배송완료</td>
									<td class="btnBox">
										<button class="order-sub-btn order-review">리뷰작성</button>
									</td>
								</tr>
								<tr>
									<td class="align_left">
										<div>
											<img src="../STATIC/img/book/9791186993095.jpg">
											<span class="ord_num">
												<span class="label">주문번호 :</span>
												<a >
													<span class="text">1643706618</span>
												</a>
												<p>검은꽃 외 1권</p>
											</span>

										</div>
									</td>
									<td>10,500원</td>
									<td class="cmain fwb">취소완료</td>
									<td class="btnBox">
										<button class="order-sub-btn order-rebuy">재구매</button>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
					<div class="pagenate"></div>
					<?php } ?>
				</article>
			</div>
		</section>
	</div>
	<!-- 리뷰작성 화면 -->
	<div id="reviewAddModal" class="modal">
	  	<div class="modal-content mh550">
	    	<div class="modal-title mb5">
	    		<h3>리뷰작성</h3>
	    		<span class="close modalCloseBtn" id="addClose">&times;</span>
	    	</div>
	    	<div class="review-content">
	    		<select class="choiceBook">
	    			<option value="">작별인사</option>
	    		</select>
	    		<div class="spacing"></div>
	    		<div class="titleBox">
	    			<img src="../STATIC/img/book/9791191114225.jpg" class="reviewImg">
	    			<span class="pl10">
	    				<span class="fs16 fwb pb5">작별인사</span>
	    				<p>김영하</p>
	    				<div class="stars" data-rating="">
						    <i class="far fa-star" data-value="1"></i>
						    <i class="far fa-star" data-value="2"></i>
						    <i class="far fa-star" data-value="3"></i>
						    <i class="far fa-star" data-value="4"></i>
						    <i class="far fa-star" data-value="5"></i>
						</div>
						<input type="hidden" id="rating" name="rating" value="5">
	    			</span>
	    		</div>
	    		
	    		<form id="reviewForm">
	    			<h3>리뷰작성</h3>
		    		<textarea id="reviewTxt" placeholder="내용을 10자 이상 입력해주세요."></textarea>
	    		</form>
	    	</div>
	    	<div class="dpflex-center-center">
	    		<button class="addBtn" id="addReviewBtn">리뷰작성</button>
	    	</div>
	  	</div>
	</div>

	
	<?php include '../footer.html'; ?>
	<script type="text/javascript">
	var currentPage = 1;
	var dataType = 'all';
	var reviewBookIx;

	$(document).ready(function() {
		var type = "<?=$type?>";
		getOrderList(currentPage,type);
		setPageButton(currentPage);


	});

	


	function getOrderList(page,type){
		$.ajax({
          	type: 'POST',
          	url: '../API/order_list_api.php', // 서버 측의 파일 경로 또는 URL
          	dataType: 'json',
          	data: { page: page, type:type },
          	success: function (response) {
            // 서버로부터의 응답 처리
            	console.log(response);
            	$('#orderData').html("");
            	$.each(response.data, function(index, item){
            		// console.log(i);
	                $('#orderData').append('<tr data-ix='+item.order_ix+'><td class="align_left"><div><img src=.'+item.img_path+'><span class="ord_num"><span class="label">주문번호 :</span><a><span class="text">'+item.order_num+'</span></a><p>'+item.title+'</p></span></div></td><td>'+item.total_amount+'원</td><td class="cmain fwb">'+item.status_txt+'</td><td class="btnBox"><button class="order-sub-btn '+item.btn_class+'">'+item.btn_txt+'</button></td></tr>');

	                if(item.status=='completed'){
	                	$('#orderData tr:eq('+index+') .btnBox').append('<button class="order-sub-btn order-return">회수신청</button>');
	                }


	            });

            	if ((page - 1) % 5 === 0) {
                  loadPagination(response.startPage,response.endPage,response.totalPages);
                  setPageButton(page);
                }

          	},
          	error: function () {
            // 오류 처리
            	$('#result').text('Error occurred.');
          	}
        });
	}

	function loadPagination(startPage,endPage,totalPages){
		var paginationHtml = '<ul>';

		if(startPage!=1){
			paginationHtml += '<li id="prev_btn" class="first_">';
			paginationHtml += '<a><img src="STATICE/img/icon/tool/first_.svg"></a>';
			paginationHtml += '</li>';
		}

		for(var i = startPage; i <= endPage; i++){
			paginationHtml += '<li id="page-'+i+'" class="paginate_button_num" data-page="'+i+'">';
			paginationHtml += '<a>'+i+'</a></li>';
		}

		if(endPage!=totalPages){
			paginationHtml += '<li id="next-btn" class="last_">';
			paginationHtml += '<a><img src="STATIC/img/icon/tool/last_.svg"></a>';
			paginationHtml += '</li>';
		}

		paginationHtml += '</ul>';

		$('.pagenate').html(paginationHtml);
	}

	// 페이지 클릭 이벤트 처리
    $(document).on('click', '.paginate_button_num', function(){
        var page = $(this).attr('data-page');
        getOrderList(page,dataType);
        currentPage = page;
        setPageButton(currentPage);
    });
	
	function setPageButton(currentPage) {
        $(".paginate_button_num").removeClass('active');
        $("#page-"+currentPage).addClass('active');
    }

    $(document).on("click", "#prev-btn", function() {
        jumpPage -= 10;
        loadTableData(jumpPage);
        setPageButton(jumpPage);
    });

    $(document).on("click", "#next-btn", function() {
        jumpPage += 10;
        loadTableData(jumpPage);
        setPageButton(jumpPage);
    });


    $(".category-btn-list li a").click(function(){
    	$(".category-btn-list li a").removeClass('active-category-btn');
    	$(this).addClass('active-category-btn');

    	dataType = $(this).attr('data-v');
    	console.log(dataType);
    	getOrderList(1,dataType);
    });

    $(document).on("click", ".order-cancel", function() {
     	var orderIx = $(this).closest('tr').attr('data-ix');
     	chkSwalAlert('주문을 취소하시겠습니까?',orderCancel,orderIx);
    });

    function orderCancel(orderIx){
     	$.ajax({
          	type: 'POST',
          	url: '../API/order_cancel_api.php', // 서버 측의 파일 경로 또는 URL
          	dataType: 'json',
          	data: { orderIx: orderIx},
          	success: function (response) {
            // 서버로부터의 응답 처리
            	if(response.resultCode==1){
            		locationAlert('주문이 취소되었습니다.','./order-list.html?type=cancelled');
            	}

          	},
          	error: function () {
            // 오류 처리
            	$('#result').text('Error occurred.');
          	}
        });
    }

    // 리뷰작성
    $(document).on("click", ".order-review", function() {
     	var orderIx = $(this).closest('tr').attr('data-ix');
     	console.log(orderIx);
     	getInfo(orderIx);

     	document.getElementById('reviewAddModal').style.display = 'block';
     	$("#reviewTxt").val("");
		// $("input[name='basicDelivery']").prop("checked",false);

     	// showSwalAlert('주문을 취소하시겠습니까?','확인',orderCancel,orderIx);
    });

	// 모달 닫기
	$(".modalCloseBtn").click(function(){
		chkSwalAlert('작성된 리뷰는 저장되지 않습니다. 닫으시겠습니까?',reviewClose,'');
	});
	function reviewClose(){
		$(".modalCloseBtn").closest('.modal').css('display','none');
	}

	var choiceArray;

	function getInfo(orderIx){
		$.ajax({
          	type: 'POST',
          	url: '../API/orderIx_get_api.php', // 서버 측의 파일 경로 또는 URL
          	dataType: 'json',
          	data: { orderIx: orderIx},
          	success: function (response) {
            // 서버로부터의 응답 처리
            	$(".choiceBook").html("");
            	choiceArray = response.dataResult;
            	$.each(response.dataResult, function(index, item){
            		$(".choiceBook").append("<option value="+item.ownership_ix+" data-id="+index+">"+item.title+"</option>");
            	});
            	$(".titleBox").html('<img src=".'+response.dataResult[0].image_path+'" class="reviewImg"><span class="pl10"><span class="fs16 fwb pb5">'+response.dataResult[0].title+'</span><p>'+response.dataResult[0].author+'</p><div class="stars" data-rating=""><i class="far fa-star fas" data-value="1"></i><i class="far fa-star fas" data-value="2"></i><i class="far fa-star fas" data-value="3"></i><i class="far fa-star fas" data-value="4"></i><i class="far fa-star fas" data-value="5"></i></div><input type="hidden" id="rating" name="rating" value="5"></span>');
            	

          	},
          	error: function () {
            // 오류 처리
            	$('#result').text('Error occurred.');
          	}
        });
	}

	// 리뷰작성 책 선택
	$(document).on("change", ".choiceBook", function() {
		var index = $(this).find(":selected").data('id');
		$(".titleBox").html('<img src=".'+choiceArray[index].image_path+'" class="reviewImg"><span class="pl10"><span class="fs16 fwb pb5">'+choiceArray[index].title+'</span><p>'+choiceArray[index].author+'</p><div class="stars" data-rating=""><i class="far fa-star fas" data-value="1"></i><i class="far fa-star fas" data-value="2"></i><i class="far fa-star fas" data-value="3"></i><i class="far fa-star fas" data-value="4"></i><i class="far fa-star fas" data-value="5"></i></div><input type="hidden" id="rating" name="rating" value="5"></span>');
		reviewBookIx = choiceArray[index].book_ix;
	});


	// 작성하기 버튼
	$("#addReviewBtn").click(function(){
		chkSwalAlert('리뷰를 작성 하시겠습니까?',reviewCreate,reviewBookIx);
	});

	function reviewCreate(reviewBookIx){
		$.ajax({
          	type: 'POST',
          	url: '../API/review_create_api.php', // 서버 측의 파일 경로 또는 URL
          	dataType: 'json',
          	data: { reviewBookIx: reviewBookIx, reviewTxt : $("#reviewTxt").val(),reviewRate:$("input[name='rating']").val()},
          	success: function (response) {
            // 서버로부터의 응답 처리
            	console.log(response);
            	if(response.resultCode==1){
            		newAlert('리뷰가 작성되었습니다.');
            		$(".modalCloseBtn").closest('.modal').css('display','none');
            	}else if(response.resultCode==-1){
            		newAlert('이미 작성된 리뷰가 있습니다.');
            	}else{
            		newAlert('문제가 발생하였습니다. 관리자에게 문의해주세요.');
            	}

          	},
          	error: function () {
            // 오류 처리
            	$('#result').text('Error occurred.');
          	}
        });
	}

	$(document).on("click", ".stars i", function(event) {
		const star = $(this);
		const value = star.attr('data-value');
        document.getElementById('rating').value = value;

        // 클릭된 별표와 그 이전의 모든 별표에 대해 클래스를 조작
        // const stars = $(".stars i");
        $('.stars i').each(function(index, element) {
            if (index < value) {
                element.classList.add('fas');
            } else {
                element.classList.remove('fas');
            }
        });
	});



	$(document).on("click", ".order-return", function(event) {
		var orderIx = $(this).closest('tr').attr('data-ix');
		chkSwalAlert('회수를 요청 하시겠습니까? 회수요청은 다시 취소할 수 없습니다.',returnCreate,orderIx);
	});

	function returnCreate(orderIx){
		$.ajax({
          	type: 'POST',
          	url: '../API/order_return_api.php', // 서버 측의 파일 경로 또는 URL
          	dataType: 'json',
          	data: { orderIx: orderIx},
          	success: function (response) {
            // 서버로부터의 응답 처리
            	console.log(response);
            	if(response.resultCode==1){
            		locationAlert('회수요청이 완료되었습니다.','./order-list.html?type=retrieval');
            	}else{
            		newAlert('문제가 발생하였습니다. 관리자에게 문의해주세요.');
            	}

          	},
          	error: function () {
            // 오류 처리
            	$('#result').text('Error occurred.');
          	}
        });
	}

	</script>
</body>
</html>