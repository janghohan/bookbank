<?php 
include './dbConnect.php';

$myUserIx = $_COOKIE['user_ix'];

$delivery_sql = "SELECT * FROM delivery WHERE user_ix='0' ORDER BY is_basic DESC, create_time DESC";
$delivery_result = $conn->query($delivery_sql);

$myInfoSql = "SELECT * FROM user WHERE user_ix='$myUserIx'";
$myInfoResult = $conn->query($myInfoSql);
$myInfoRow = $myInfoResult->fetch_assoc();

$myPoint = $myInfoRow['points'];

 ?>

<!DOCTYPE html>
<html>
<head>
	<meta name="code" charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=0,maximum-scale=10,user-scalable=yes"/>
	<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
	<script type="text/javascript" src="STATIC/js/common.js"></script>
	<script type="text/javascript" src="STATIC/js/swiper-bundle.min.js"></script>
	<link rel="stylesheet" type="text/css" href="STATIC/css/swiper-bundle.min.css"/>
	<link rel="stylesheet" type="text/css" href="STATIC/css/style.css"/>
</head>
<style type="text/css">

	.cart-book-info .info-box .prod_price{
		padding-bottom: 15px;
	}
	.cart-book-info .info-box .percent{
		display: inline-block;
	    margin-right: 6px;
	    color: #4dac27;
	    font-size: 16px;
	    line-height: 36px;
	    letter-spacing: -0.01em;
	    font-weight: 700;
	    vertical-align: top;
	}
	.cart-book-info .info-box .price{
		display: inline-block;
	    margin-right: 4px;
	    color: #000;
	    font-size: 18px;
	    line-height: 33px;
	    letter-spacing: -0.01em;
	    vertical-align: top;
	}
	.cart-book-info .info-box .price .val{
		display: inline-block;
    	font-weight: 700;
	}
	.cart-book-info .info-box .sale_price{
		display: inline-block;
	    margin-bottom: 2px;
	    color: #767676;
	    font-size: 14px;
	    line-height: 33px;
	    letter-spacing: -0.01em;
	    vertical-align: bottom;
	}

	.guide_box{
	    display: flex;
	    justify-content: space-between;
	    padding: 10px 0px;
	}
	.guide_box .guide_title{
	    font-size: 14px;
	    line-height: 22px;
	    letter-spacing: -0.01em;
	    
	}
	.guide_cont .val{
	    color: #4dac27;
	    font-size: 15px;
	    line-height: 23px;
	    letter-spacing: -0.01em;
	    font-weight: 700;
	    vertical-align: top;
	    padding-right: 5px;
	}
	.prod_alarm_text {
	    color: #595959;
	    font-size: 13px;
	    display: inline-block;
	    width: 190px;
	}
	.btn_line_primary{
		color: #474c98;
	    border: 1px solid #5055b1;
	    background: #fff;
	    transition: background-color 0.2s ease-out, border-color 0.2s ease-out;
	    padding: 5px;
	}


	/*order*/

	.order_detailArea{
		border: 1px solid #eaeaea;
	    border-radius: 25px;
	    padding: 25px;
	    width: 850px;
	    margin-top: 20px;
	
	}

	.order-title {
		border-bottom: 1px solid #eaeaea;
		padding-bottom: 25px;
	}
	.order-list{
		border-collapse: collapse; /* 테이블 경계를 합치도록 설정 */
        width: 100%;
	}
	.order-list .list-body .img{
		display: flex;
		justify-content: flex-start;
		align-items: center;
		margin-top: 15px;
	}
	.order-list .list-body .blank{
		/*width: 450px;*/
	}
	.order-list .list-body .cnt,.price{
		width: 80px;
	}
	.order-list .list-body .img img{
		width: 80px;
		height: 120px;
	}


	.aside_section .inner > .content{
		width: 1200px;
	}
	h1{
		font-size: 28px;
	}
	.cart_details{
		position: relative;
	}
	.cart_details .content {
	    margin-bottom: 0px;
	    width: 850px;

	}
	.cart_details .side_area {
	    width: 300px;
	    height: 100%;
	    position: absolute;
	    left: 900px;
	    top: 0;
	}

	.cart_details .side_area .sticky {
	    position: relative;
	    top: 0px;
	    left: 0;
	}
	.cart_details .cart-header{
		border-top: 2px solid #e7e7e7e7;
		border-bottom: 1px solid #eaeaea;

	}



	#swal2-content{
		font-size: 14px !important;
		font-weight: 700 !important;
	}
	.swal2-popup{
		width: 300px !important;
		height: 190px;
	}


	/*배송정보*/
	.delivery_section{
		border: 1px solid #eaeaea;
	    border-radius: 25px;
	    padding: 25px;
	    width: 850px;
	
	}
	.delivery_row{
		display: flex;
	    justify-content: flex-start;
	    align-items: baseline;
	}
	.delivery_row .title{
		width: 120px;
    	font-weight: 700;
	}
	.delivery_row .cnt{
		width: 678px;
		margin-bottom: 30px;
	}

	.delivery_row .cnt .edit{
		line-height: 5px;
    	padding-right: 7px;
	}

	.delivery_row .cnt img{
		width: 15px;
	}
	.delivery_row .cnt button{
		width: 100%;
		height: 40px;
		font-weight: 700;
		font-size: 14px;
		display: flex;
		justify-content: center;
		align-items: center;
	}
	.delivery_row textarea{
		height: 60px;
	}

</style>
<body>
	<?php include 'header.html'; ?>	
	<div id="container">
		<section class="aside_section">
			<div class="inner">
				<article class="content">
					<h1 class="mb30">주문/결제</h1>
					<section class="cart_details">

						<article class="delivery_section">
							<div class="delivery_row">
								<div class="title">
									배송지 정보
								</div>
								<?php 
								if($delivery_result->num_rows <= 0){

								 ?>
								<div class="cnt">
									<p class="fs13 cmain fw700 mb10">
										<span>
											<img src="./STATIC/img/icon/map2.png">
										</span>
									기본배송지를 등록해주세요</p>
									<button class="btn_line_gray bdr7 newDeliveryBtn">
										<span class="edit">
											<img src="./STATIC/img/icon/edit.png">
										</span>
									배송지 입력</button>
								</div>
								<?php }else{ 

								$basic_sql = "SELECT * FROM delivery WHERE user_ix='0' AND is_basic='1'";
								$basic_result = $conn->query($basic_sql);
								$basic_row = $basic_result -> fetch_assoc();
								$basicDelivery_ix = $basic_row['delivery_ix'];

								?>
								<div class="cnt">
									<div class="dpflex-start-center">
										<h3 class="basic_title mr10 cmain"><?=$basic_row['delivery_name']?></h3>
										<span class="btn_line_green bdr7 fs13 pd3 mr5 basicTxt">기본배송지</span>
										<button class="subBtn newDeliveryBtn" style="width: 50px; height: 25px;">변경</button>
									</div>
									<div class="mt5">
										<p class="basic_person"><?=$basic_row['receiver_name']." / ".$basic_row['receiver_contact']?></p>
									</div>
									<div class="mt10">
										<p class="basic_add"><?=$basic_row['receiver_address']." ".$basic_row['receiver_address2']?></p>
									</div>
								</div>
								<?php } ?>
							</div>
							<div class="delivery_row">
								<div class="title">
									배송메모
								</div>
								<textarea class="cnt bdr7" id="memo"></textarea>
							</div>
						</article>
						
						<article class="content">
							<section class="order_detailArea">
								<div class="order-title">
									<h3>주문목록 (2)</h3>
								</div>
								<table class="order-list">
									<thead>
										<tr>
											<th></th>
											<th></th>
											<th></th>
											<th></th>
										</tr>
									</thead>
									<tbody class="list-body">
										<?php 
										$tmpOrderSql = "SELECT * FROM tmp_order JOIN books ON tmp_order.book_ix=books.book_ix AND tmp_order.user_ix='$myUserIx'";
										$tmpOrderResult = $conn->query($tmpOrderSql);
										$rentalPrice = 0;
										$totalPoint = 0;

										while($tmpOrderRow = $tmpOrderResult->fetch_assoc()){
											$rentalPrice = $rentalPrice + $tmpOrderRow['rental_price'];
											$totalPoint = $totalPoint + $tmpOrderRow['point'];
										 ?>
										<tr>
											<td class="img">
												<img src="<?=$tmpOrderRow['image_path']?>">
												<div>
													<h4 class="pl15"><?=$tmpOrderRow['title']?></h4>
													<p class="pl15 fs13"><?=$tmpOrderRow['author']?></p>
												</div>
											</td>
											<td class="blank"></td>
											<td class="cnt">1개</td>
											<td class="price">
												 <span class="fw700"><?=number_format($tmpOrderRow['rental_price'])?><span class="unit">원</span></span>
											</td>
										</tr>
										<?php } ?>
										
									</tbody>
								</table>
								
							</section>
							<style type="text/css">
								.caution_wrap{
									margin: 0 auto;
									margin-top: 80px;
								}
								.caution_title{
									min-height: 38px;
									padding-bottom: 32px;
								}
								.caution_title .title_div{
									font-size: 20px;
									font-weight: bold;
								}
								.caution_info{
									border-top: 1px solid #000;
									padding: 15px 0;
								}
								.caution_sub_info {
									border-bottom: 1px solid #eaeaea;
									padding: 40px 0;
								}
								.caution_sub_info:last-child{
									border-bottom: none;
								}
								.caution_sub_info .caution_sub_title{
									font-size: 16px;
									font-weight: bold;
									padding-bottom: 8px;
									color: #000;
								}
								.caution_sub_info .caution_sub_con{
									line-height: 25px;
								}
							</style>
							<!-- <section class="caution_wrap" id="caution_wrap">
								<ul class="caution_info">
									<li class="caution_sub_info">
										<div class="caution_sub_title">
											장바구니 주의사항
										</div>
										<p class="caution_sub_con">
											택배 및 회수배송비 5,000원이 부과됩니다.
											<br>상품은 묶음으로 한번에 배송됩니다.

										</p>
									</li>
								</ul>
							</section> -->
						</article>

						<style type="text/css">
							.point-area{
								border: 1px solid #eaeaea;
							    border-radius: 25px;
							    padding: 25px;
							    width: 850px;
							    margin-top: 20px;
							}
							.point-box{
								background-color: #eaeaea;
								margin-top: 35px;
								border-radius: 20px;
							}
							.point-list{
								display: flex;
								justify-content: flex-start;
								align-items: center;
								padding: 15px 50px;
							}
							.myPoint{
								width: 100px;
								text-align: right;
								margin-left: 40px;
								margin-right: 25px;
							}
							.myPoint .cmain{
								font-size: 18px;
								font-weight: bold;
							}
							.point-list input{
								text-align: right;
							}
							.point-list .btn_line_green{
								padding: 10px;
								margin-left: 30px;
								border-radius: 5px;
								font-weight: 600;
							}
						</style>

						<article class="point-area">
							<div class="point-title">
								<div>
									<span class="fwb">포인트</span>
									<span class="pl30">보유 <span class="possiPoint"><?=$myPoint?></span>원</span>
								</div>
							</div>
							<div class="point-box">
								<div class="point-list">
									<div class="fwb">통합포인트</div>
									<div class="myPoint"><span class="cmain usePoint">0</span> 원</div>
									<input type="number" class="bdr7 pointInput" placeholder="0 원">
									<button class="btn_line_green" id="allPointBtn">전액사용</button>
								</div>
							</div>
						</article>

						<style type="text/css">
							.pay-area{
								border: 1px solid #eaeaea;
							    border-radius: 25px;
							    padding: 25px;
							    width: 850px;
							    margin-top: 20px;
							}
							.pay-box{
								margin-top: 15px;
							}
							.pay-box .roww{
								display: flex;
								align-items: center;
							}
							.pay-box .roww label{
								padding-left: 5px;
							}
						</style>

						<article class="pay-area">
							<h3>결제수단</h3>
							<div class="pay-box">
								<div class="roww">
									<input type="radio" name="payVal" id="mutong" checked="true">
									<label id="mutong">무통장입금</label>
								</div>
							</div>
						</article>

						<style type="text/css">
							.agree-area{
								border: 1px solid #eaeaea;
							    border-radius: 25px;
							    padding: 15px;
							    width: 850px;
							    margin-top: 20px;
							}
							.term_wrap .term{
								width: 850px;
							}
							.term_wrap .term .drop_btn{
								width: 15px;
								padding: 0;
								margin-right: 35px;
							}
							.term_wrap .term .drop_btn.active{
								background-color: #fff;
							}
						</style>

						<article class="agree-area term_wrap">
							<div class="term">
								<div class="checkbox_">
									<label>개인정보 수집 및 이용동의</label>
								</div>
								<div class="drop_btn">
									<img src="./STATIC/img/icon/tool/arrow_down_m.svg">
								</div>
							</div>
							<div class="dorp_wrap">
								<div class="text"><?php include './personalinfo.html'; ?></div>
							</div>

						</article>


						<style type="text/css">
							.list_area{
								border: 1px solid #eaeaea;
								border-radius: 10px;
							}

							.list_area .details{
								padding: 15px;
							}
						</style>

						<article class="side_area">
							<section class="sticky">
								<article class="list_area">
									<div class="details">
								        <div class="guide_box ">
								        	<div class="guide_title">
								        		상품금액
								        	</div>
								        	<div class="guide_cont">
								        		<?=number_format($rentalPrice)?>원
								        	</div>
								        </div>
								        <div class="guide_box">
								        	<div class="guide_title">
								        		배송비
								        	</div>
								        	<div class="guide_cont">
								        		+ 5,000원
								        	</div>
								        </div>
								        <div class="guide_box bt-bar">
								        	<div class="guide_title">
								        		포인트 사용
								        	</div>
								        	<div class="guide_cont">
								        		<span class="usePoint">0</span>원
								        	</div>
								        </div>
								        <div class="guide_box ">
								        	<div class="guide_title fw700 c00">
								        		총 결제 금액
								        	</div>
								        	<div class="guide_cont">
								        		<div class="fs20">
								        			<span class="val fs22 totalPayPrice"><?=number_format($rentalPrice+5000)?></span>원
								        		</div>
								        	</div>
								        </div>
								        <div class="guide_box">
								        	<div class="guide_title">
								        		적립예정 포인트
								        	</div>
								        	<div class="guide_cont">
								        		<?=$totalPoint?>P
								        	</div>
								        </div>
									</div>
								</article>
								<article class="apply_area mt30">
									<div class="btn_area mt0">
										<button class="submitBtn" id="orderBtn">주문하기</button>
									</div>
								</article>
							</section>
						</article>
					</section>
				</article>
			</div>
		</section>

	</div>
	<style type="text/css">
		.modal {
		  display: none;
		  position: fixed;
		  top: 0;
		  left: 0;
		  width: 100%;
		  height: 100%;
		  background-color: rgba(0, 0, 0, 0.5);
		}

		.modal-content {
		  background-color: #fff;
		  margin: 10% auto;
		  padding: 20px;
		  border: 1px solid #888;
		  width: 560px;
		  border-radius: 15px;
		  min-height: 650px;
		  position: relative;
		}
		.modal-title{
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.close {
		  color: #aaa;
		  float: right;
		  font-size: 28px;
		  font-weight: bold;
		}

		.close:hover,
		.close:focus {
		  color: black;
		  text-decoration: none;
		  cursor: pointer;
		}
		#newBtn{
			margin-top: 15px;
			width: 100%;
			padding: 8px;
			border-radius: 10px;
		}
		.empty{
			position: absolute;
		    top: 50%;
		    left: 50%;
		    transform: translateX(-50%);
		}

		.delivery-content{
			padding-top: 20px;
			border-top: 1px solid #eaeaea;
		}
		#addSearchBtn, #editAddSearchBtn{
			height: 35px;
			width: 100%;
			margin-top: 5px;
		}
		#addSaveBtn, #addEditBtn{
			width: 120px;
			margin-top: 40px;
			height: 40px;
		}


		.address_list{
			margin-top: 24px;
			overflow-y: auto;
			max-height: 400px;
			min-height: 400px;
		}
		.address_info_box{
			flex: 1;
		}
		.btn_wrap{
			margin-left: 15px;
		}
		.address_item{
			display: flex;
			justify-content: center;
			align-items: center;
			border: 1px solid #d5d5d5;
			border-radius: 10px;
			background-color: #fff;
			padding: 18px;
			margin-bottom: 10px;
			font-size: 14px;
		}
		.form_rdo{
			margin-right: 15px;
		}
		.form_rdo label{
			display: none;
		}
		#choiceDeliveryBtn{
			width: 150px;
		}
		.
	</style>
	<!-- 배송지없음 -->
	<!-- <div id="deliveryListModalEmpty" class="modal">
	  	<div class="modal-content">
	    	<div class="modal-title">
	    		<h3>배송지 추가</h3>
	    		<span class="close" id="deliveryCloseEmpty">&times;</span>
	    	</div>
	    	<button class="btn_line_green fwb" id="newBtn">배송지 추가</button>
	    	<div class="empty">
	    		<span>등록된 배송지가 없습니다.</span>
	    	</div>
	  	</div>
	</div> -->

	<!-- 배송지있음 -->
	<div id="deliveryListModal" class="modal">
	  	<div class="modal-content">
	    	<div class="modal-title">
	    		<h3>배송지 추가</h3>
	    		<span class="close modalCloseBtn" id="deliveryClose">&times;</span>
	    	</div>
	    	<button class="btn_line_green fwb" id="newBtn">배송지 추가</button>
	    	<div class="list">
	    		<ul class="address_list" style="" data-pop-delivery-list="list">

	    			<?php 
	    			
	    			while($delivery_row = $delivery_result->fetch_assoc()){
	    			 ?>
	    			

				    <li class="address_item">
				        <div class="address_chk_box">
				            <span class="form_rdo no_label">
				                <?php 
				                if($delivery_row['is_basic']==1){
				                 ?>
				                <input type="radio" value="<?=$delivery_row['delivery_ix']?>" name="pop_delivery_list_item" checked="true">
				                <?php }else{ ?>
				                <input  type="radio" value="<?=$delivery_row['delivery_ix']?>" name="pop_delivery_list_item">
				                <?php } ?>
				                <label for="chkAddressList01-2">배송지 선택</label>
				            </span>
				        </div>
				        <div class="address_info_box">
				            <div class="address_name">
				                <span class="delivery_name fc_spot fwb"><?=$delivery_row['delivery_name']?></span>
				                <?php 
				                if($delivery_row['is_basic']==1){
				                 ?>
				                 <span class="badge_sm badge_pill badge_line_primary"><span class="btn_line_green bdr7 fs12 pd3">기본배송지</span></span>
				             	<?php } ?>
				                
				                
				                
				            </div>
				            <div class="address_person mt5">
				                <span class="name"><?=$delivery_row['receiver_name']?> /</span>
				                <span class="phone_number"><?=$delivery_row['receiver_contact']?></span>
				            </div>
				            <div class="address mt5"><?=$delivery_row['receiver_address']." ".$delivery_row['receiver_address2']?></div>
				            <input type="hidden" class="address_detail" value="<?=$delivery_row['receiver_address2']?>">
				        </div>
				        <div class="btn_wrap">
				            <button type="button" class="btn_xs btn_line_green pd5 bdr7 editBtn" data-id="<?=$delivery_row['delivery_ix']?>" data-dvsn-code="100"><span class="text">수정</span></button>
				            
				            <button type="button" class="btn_xs btn_light_gray pd5 bdr7 deleteBtn" data-id="<?=$delivery_row['delivery_ix']?>"><span class="text">삭제</span></button>
				            
				        </div>
				    </li>
					<?php } ?>

				    
				</ul>
	    	</div>
	    	<div class="basicDelivery-area">
	    		<div class="address_chk_box">
		            <span class="no_label dpflex-center-center">
		                <input id="basicDelivery" type="checkbox" name="basicDelivery" data-pop-delivery-list-item="check" data-key="2">
		                <label for="basicDelivery" class="pl5">기본 배송지 선택</label>
		            </span>
		        </div>
	    	</div>
	    	<div class="dpflex-center-center">
	    		<button class="submitBtn" id="choiceDeliveryBtn">선택</button>
	    	</div>
	  	</div>
	</div>

	<!-- 배송지추가 화면 -->
	<div id="deliveryAddModal" class="modal">
	  	<div class="modal-content mh550">
	    	<div class="modal-title mb5">
	    		<h3>배송지 추가</h3>
	    		<span class="close modalCloseBtn" id="addClose">&times;</span>
	    	</div>
	    	<div class="delivery-content">
	    		<form id="newAddForm">
	    			<h3>배송지이름</h3>
		    		<input type="text" name="delivery_name" class="bdr7 mt15">
		    		<h3 class="mt20">받는분</h3>
		    		<input type="text" name="receiver_name" class="bdr7 mt10" placeholder="이름을 입력해주세요.">
		    		<input type="text" name="receiver_contact" class="bdr7 mt10" placeholder="휴대폰번호를 -없이 입력해주세요.">
		    		<h3 class="mt20">주소</h3>
		    		<input type="text" name="new_address" class="bdr7 mt15">
		    		<input type="text" name="new_address_detail" class="bdr7 mt10" placeholder="상세주소를 입력해주세요.">
	    		</form>
	    		<button id="addSearchBtn" class="subBtn">주소검색</button>
	    	</div>
	    	<div class="dpflex-center-center">
	    		<button class="submitBtn" id="addSaveBtn">저장</button>
	    	</div>
	  	</div>
	</div>

	<!-- 배송지수정 화면 -->
	<div id="deliveryEditModal" class="modal">
	  	<div class="modal-content mh550">
	    	<div class="modal-title mb5">
	    		<h3>배송지 수정</h3>
	    		<span class="close modalCloseBtn" id="addClose">&times;</span>
	    	</div>
	    	<div class="delivery-content">
	    		<form id="editAddForm">
	    			<h3>배송지이름</h3>
	    			<input type="hidden" name="deliver_edit_ix" value="">
		    		<input type="text" name="delivery_edit_name" class="bdr7 mt15">
		    		<h3 class="mt20">받는분</h3>
		    		<input type="text" name="receiver_edit_name" class="bdr7 mt10" placeholder="이름을 입력해주세요.">
		    		<input type="text" name="receiver_edit_contact" class="bdr7 mt10" placeholder="휴대폰번호를 -없이 입력해주세요.">
		    		<h3 class="mt20">주소</h3>
		    		<input type="text" name="edit_address" class="bdr7 mt15">
		    		<input type="text" name="edit_address_detail" class="bdr7 mt10" placeholder="상세주소를 입력해주세요.">
	    		</form>
	    		<button id="editAddSearchBtn" class="subBtn">주소검색</button>
	    	</div>
	    	<div class="dpflex-center-center">
	    		<button class="submitBtn" id="addEditBtn">저장</button>
	    	</div>
	  	</div>
	</div>
	<?php include './footer.html'; ?>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
	<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
	<script type="text/javascript">
		var deliveryIx = "<?=$basicDelivery_ix?>";

		$(window).on('load', function() {
		  	var fixedDiv = $(".side_area");
		  	var initialOffset = fixedDiv.offset().top;

		  	$(window).scroll(function() {
		    	var scrollTop = $(window).scrollTop();
		    	var leftOffset = $(".cart_details").offset().left;

		    
		    	if (scrollTop >= initialOffset) {
			      	// 스크롤 위치가 초기 위치를 넘어갈 때 고정
			      	fixedDiv.css({
			        	position: "fixed",
			        	top: 50,
			        	left: leftOffset+900
			      	});
			    } else {
			      	// 스크롤 위치가 초기 위치 이하일 때 절대 위치로 변경
			      	fixedDiv.css({
			        	position: "absolute",
			        	top: 0,
			        	left:900
			      	});
			    }
			});
		});
		
		$("#orderBtn").click(function(){

			Swal.fire({
		      	text: "도서를 대여하시겠습니까?",
		      	showCancelButton: true,
		      	confirmButtonColor: '#4dac27',
		      	cancelButtonColor: '#767676',
		      	confirmButtonText: '확인',
		      	cancelButtonText: '취소',
		    }).then((result) => {
		      	if (result.isConfirmed) {
		       		order();
		      	} else if (result.dismiss === Swal.DismissReason.cancel) {
		        // Swal.fire('취소', '작업이 취소되었습니다.', 'error');
		        // 여기에 취소 버튼을 눌렀을 때의 동작을 추가할 수 있습니다.
		      	}
		    });

		});

		// 대여하기 버튼
		function order(){
			$.ajax({
	          	type: "POST",
	          	dataType: 'json',
	          	url: "./API/order_create_api.php", // 실제 서버 엔드포인트로 교체
	          	data: {usePoint : $(".pointInput").val(), totalPrice : $(".totalPayPrice").text() , deliveryIx:deliveryIx, memo:$("#memo").val()},
	          	success: function (response) {
	            // 성공적으로 응답을 받았을 때의 처리;
	            	console.log(response);
	            	if(response.resultCode==1){
	            		Swal.fire({
					      	text: txt,
					      	confirmButtonColor: '#4dac27',
					      	confirmButtonText: '확인',
					    }).then((result) => {
					    	
					    });
	            		// location.href='./order-complete.html';
	            	}else{
	            		alert('문제가 발생했습니다. 관리자에게 문의해주세요.');
	            	}
	            	
	            	// $('#singup_form :input').val('');
	          	},
	          	error: function (error) {
	            // 오류 발생 시의 처리
	            	console.error("Error:", error);
	          	}
	        });
		}


		$('.drop_btn').click( function(){
			var $this = $(this);
			var $parent = $this.parents('article');
			$this.toggleClass('active');
			if($this.hasClass('active')){
				$parent.find('.dorp_wrap').slideDown(300);
			} else {
				$parent.find('.dorp_wrap').slideUp(300);
			}
		})

		

		// 주소검색
		$("#addSearchBtn").click(function(){
			new daum.Postcode({
		        oncomplete: function(data) {
		        	console.log(data);
		            $("input[name='new_address']").val("["+data.zonecode+"] "+data.address);
		            $("input[name='new_address_detail").focus();
		        }
		    }).open();
		});
		$("#editAddSearchBtn").click(function(){
			new daum.Postcode({
		        oncomplete: function(data) {
		        	console.log(data);
		            $("input[name='edit_address']").val("["+data.zonecode+"] "+data.address);
		            $("input[name='edit_address_detail").focus();
		        }
		    }).open();
		});

		// 배송지추가
		$("#addSaveBtn").click(function(){
			var dataForm = $("#newAddForm").serialize();

			$.ajax({
	          	type: "POST",
	          	dataType: 'json',
	          	url: "./API/delivery_create_api.php", // 실제 서버 엔드포인트로 교체
	          	data: dataForm,
	          	success: function (response) {
	            // 성공적으로 응답을 받았을 때의 처리;
	            	console.log(response);
	            	if(response.resultCode==1){
	            		$(".address_list").append(response.data);
	            		document.getElementById('deliveryAddModal').style.display = 'none';
	            	}else{
	            		showAlert('문제가 발생하였습니다. 고객센터에 문의해주세요.');
	            	}
	            	// if(response.result_code==1){
	            	// 	alert('인증번호가 전송되었습니다.');
	            	// 	authNumber = response.authNumber;
	            	// }else{
	            	// 	alert('문제가 발생했습니다. 관리자에게 문의해주세요.');
	            	// }
	            	
	            	// $('#singup_form :input').val('');
	          	},
	          	error: function (error) {
	            // 오류 발생 시의 처리
	            	console.error("Error:", error);
	          	}
	        });
		});


		//배송지 삭제
		$(".deleteBtn").click(function(){
			var deliveryIx = $(this).attr('data-id');
			var li = $(this).closest('li');
			Swal.fire({
		      	text: "배송지를 삭제하시겠습니까?",
		      	showCancelButton: true,
		      	confirmButtonColor: '#4dac27',
		      	cancelButtonColor: '#767676',
		      	confirmButtonText: '확인',
		      	cancelButtonText: '취소',
		    }).then((result) => {
		      	if (result.isConfirmed) {
		       		deleteDelivery(deliveryIx,li);
		      	} else if (result.dismiss === Swal.DismissReason.cancel) {

		      	}
		    });
		});

		function deleteDelivery(deliveryIx,li){
			$.ajax({
	          	type: "POST",
	          	dataType: 'json',
	          	url: "./API/delivery_delete_api.php", // 실제 서버 엔드포인트로 교체
	          	data: {delivery_ix : deliveryIx},
	          	success: function (response) {
	            // 성공적으로 응답을 받았을 때의 처리
	            	if(response==1){
	            		li.remove();
	            	}else{

	            	}
	          	},
	          	error: function (error) {
	            // 오류 발생 시의 처리
	            	console.error("Error:", error);
	          	}
	        });
		}
		//배송지 삭제


		//배송지 편집
		var editLi;
		$(".editBtn").click(function(){
			editLi = $(this).closest('li');
			var deliveryIx = $(this).attr('data-id');

			var address = $(this).closest('li').find('.address').text();
			var address_detail = $(this).closest('li').find('.address_detail').val();
			address = address.replace(address_detail, "");

			var delivery = $(this).closest('li').find('.delivery_name').text();
			var name = $(this).closest('li').find('.name').text().replace("/","");
			var phone_number = $(this).closest('li').find('.phone_number').text();

			$("input[name='deliver_edit_ix']").val(deliveryIx);
			$("input[name='delivery_edit_name']").val(delivery);
			$("input[name='receiver_edit_name']").val(name);
			$("input[name='receiver_edit_contact']").val(phone_number);
			$("input[name='edit_address']").val(address);
			$("input[name='edit_address_detail']").val(address_detail);
			document.getElementById('deliveryEditModal').style.display = 'block';
		});

		$("#addEditBtn").click(function(){
			Swal.fire({
		      	text: "배송지를 수정하시겠습니까?",
		      	showCancelButton: true,
		      	confirmButtonColor: '#4dac27',
		      	cancelButtonColor: '#767676',
		      	confirmButtonText: '확인',
		      	cancelButtonText: '취소',
		    }).then((result) => {
		      	if (result.isConfirmed) {
		       		editDelivery();
		      	} else if (result.dismiss === Swal.DismissReason.cancel) {

		      	}
		    });
		});

		function editDelivery(){
			console.log($("#editAddForm").serialize());
			$.ajax({
	          	type: "POST",
	          	dataType: 'json',
	          	url: "./API/delivery_update_api.php", // 실제 서버 엔드포인트로 교체
	          	data: $("#editAddForm").serialize(),
	          	success: function (response) {
	            // 성공적으로 응답을 받았을 때의 처리;
	            	if(response.resultCode==1){
	            		document.getElementById('deliveryEditModal').style.display = 'none';
	            		editLi.find('.delivery_name').text(response.delivery_name);
	            		editLi.find('.name').text(response.receiver_name);
	            		editLi.find('.phone_number').text(response.receiver_contact);
	            		editLi.find('.address ').text(response.receiver_address+" "+response.receiver_address2);
	            		editLi.find('.address_detail').val(response.receiver_address2);


	            	}else{

	            	}
	            	// if(response.result_code==1){
	            	// 	alert('인증번호가 전송되었습니다.');
	            	// 	authNumber = response.authNumber;
	            	// }else{
	            	// 	alert('문제가 발생했습니다. 관리자에게 문의해주세요.');
	            	// }
	            	
	            	// $('#singup_form :input').val('');
	          	},
	          	error: function (error) {
	            // 오류 발생 시의 처리
	            	console.error("Error:", error);
	          	}
	        });
		}
		// 배송지 편집 끝

		// 배송지 선택
		$("#choiceDeliveryBtn").click(function(){
			deliveryIx = $("input[name='pop_delivery_list_item']:checked").val();
			var choiceLi = $("input[name='pop_delivery_list_item']:checked").closest('li');

			$(".basic_title").text(choiceLi.find('.delivery_name').text());
			$(".basic_person").text(choiceLi.find('.name').text()+" "+choiceLi.find('.phone_number').text());
			$(".basic_add").text(choiceLi.find('.address').text());
			document.getElementById('deliveryListModal').style.display = 'none';

			//기본선택지 체크했으면
			if($("input[name='basicDelivery']").is(":checked")){
				setBasic($("input[name='pop_delivery_list_item']:checked").val());
				$(".basicTxt").css('display','block');
			}else{
				if($("input[name='pop_delivery_list_item']:checked").val()!="<?=$basicDelivery_ix?>"){
					$(".basicTxt").css('display','none');
				}else{
					$(".basicTxt").css('display','block');
				}
			}
		});

		//기본 배송지 설정
		function setBasic(delivery_ix){
			$.ajax({
	          	type: "POST",
	          	dataType: 'json',
	          	url: "./API/delivery_basic_api.php", // 실제 서버 엔드포인트로 교체
	          	data: {delivery_ix : delivery_ix},
	          	success: function (response) {
	            // 성공적으로 응답을 받았을 때의 처리
	            	console.log(response.resultCode);
	            	// if(response==1){
	            	// 	li.remove();
	            	// }else{

	            	// }
	          	},
	          	error: function (error) {
	            // 오류 발생 시의 처리
	            	console.error("Error:", error);
	          	}
	        });
		}

		// 포인트 사용
		$(document).ready(function() {
    // 입력 필드의 값이 변할 때마다 이벤트가 발생하도록 리스너를 등록합니다.
		    $('.pointInput').on('input', function() {
		        // 입력 필드의 현재 값을 가져와서 변수에 저장합니다.
		        var inputValue = $(this).val();
		       	calPoint(inputValue);
		    });
		});

		$("#allPointBtn").click(function(){
			calPoint(parseInt("<?=$myPoint?>"));			
		});

		function calPoint(point){
			var limit = parseInt("<?=$myPoint?>");

		 	if (point > limit) {
	            // 입력 값이 특정 값 이상이면 값을 특정 값으로 설정합니다.
	            $(".pointInput").val(limit);
	            $(".usePoint").text(limit);
	        }else if(point < 0){
	        	$(".pointInput").val(0);
	            $(".usePoint").text(0);
	        }else{
	        	$(".usePoint").text(point);
	        	$(".pointInput").val(point);
	        }

	        var total = parseInt("<?=$rentalPrice?>")+5000-point;
	        var formattedValue = total.toLocaleString('en-US', {
	            style: 'decimal',
	        });
	        $(".totalPayPrice").text(formattedValue);

		}


		function showAlert(txt) {
    // 추가적인 옵션을 사용한 알림 창
		    Swal.fire({
		      	text: txt,
		      	confirmButtonColor: '#4dac27',
		      	confirmButtonText: '확인',
		    }).then((result) => {
		    	
		    });
		  }

		// 모달 열기
		$(".newDeliveryBtn").click(function(){ //배송지 추가
			document.getElementById('deliveryListModal').style.display = 'block';
			$("input[name='basicDelivery']").prop("checked",false);
		});

		$("#newBtn").click(function(){
			document.getElementById('deliveryAddModal').style.display = 'block';
		});


		// 모달 닫기
		$(".modalCloseBtn").click(function(){
			$(this).closest('.modal').css('display','none');
		});

	</script>
</body>
</html>